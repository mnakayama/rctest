# Cline Rules

## ロール定義

あなたは Vue3/Nuxt.3 + Supabase のエキスパートエンジニア兼 UI/UX デザイナーとして対応してください。

## 技術スタック

- フロントエンド
  - Vue3 (Composition API) / Nuxt.3
  - TypeScript
  - Pinia
  - Vue Router / Nuxt Router
- バックエンド
  - Supabase
  - Nuxt Server API
- 開発環境
  - Docker
  - Docker Compose
- ユニットテスト
  - Vitest
  - Nuxt Test Utils
- フォーマッター
  - Prettier
  - ESLint
- UI フレームワーク
  - Tailwind CSS
  - daisyUI
- CI/CD
  - GitHub Actions
  - Docker BuildKit

## 開発環境

### Docker設定

1. 開発環境は必ずDocker環境を使用
2. 開発、本番環境用の Dockerfile を分離
3. docker-compose.yml で開発環境の完全な再現性を確保
4. .dockerignore の適切な設定

#### Dockerfile 例

```dockerfile
# 開発環境用 Dockerfile
FROM node:20-alpine AS development

WORKDIR /app

# システム依存関係のインストール
RUN apk add --no-cache \
    git \
    python3 \
    make \
    gcc \
    g++

# パッケージのコピーとインストール
COPY package.json yarn.lock ./
RUN yarn install --frozen-lockfile

# アプリケーションコードのコピー
COPY . .

# 開発サーバーの起動
CMD ["yarn", "dev"]
```

### Docker Compose 設定

```yaml
version: '3.8'
services:
  frontend:
    build:
      context: .
      target: development
    volumes:
      - .:/app
      - /app/node_modules
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
    depends_on:
      - supabase
  
  supabase:
    image: supabase/postgres:15.1
    environment:
      - POSTGRES_PASSWORD=your_secure_password
    ports:
      - "5432:5432"
```

## 命名規約 (Naming Conventions)

### 1. 一般的な命名ルール (General Naming Rules)

#### 言語別命名規則 (Language-Specific Naming Conventions)
- TypeScript/Vue:
  - `camelCase`: 変数、関数、メソッド
  - `PascalCase`: クラス、コンポーネント、インターフェース
  - `UPPER_SNAKE_CASE`: 定数

#### 禁止事項 (Prohibited Practices)
- 一文字の変数名の使用を避ける
- 意味のない省略形の使用を避ける
- 非英語の文字（全角文字）の使用を避ける

### 2. ファイル命名規約 (File Naming Conventions)

#### コンポーネント (Components)
- `PascalCase`で命名
- 機能または目的を明確に表現
- 例:
  - `UserProfileCard.vue`
  - `AuthenticationForm.vue`
  - `ProductListItem.vue`

#### ページコンポーネント (Page Components)
- `PascalCase`で命名し、`Page`サフィックスを付与
- 対応するルートを反映
- 例:
  - `UserProfilePage.vue`
  - `ProductListPage.vue`
  - `DashboardPage.vue`

#### コンポーズ関数 (Composable Functions)
- `use`プレフィックスを使用
- `camelCase`で命名
- 機能を明確に示す
- 例:
  - `useAuthUser.ts`
  - `useFormValidation.ts`
  - `useApiClient.ts`

#### ストア (Pinia Stores)
- `use`プレフィックスと`Store`サフィックス
- `PascalCase`
- 例:
  - `useUserStore.ts`
  - `useCartStore.ts`
  - `useAuthenticationStore.ts`

#### ユーティリティ関数 (Utility Functions)
- 明確で簡潔な名前
- `camelCase`
- 機能を示すプレフィックス/サフィックス
- 例:
  - `formatCurrency.ts`
  - `validateEmail.ts`
  - `generateRandomToken.ts`

#### テストファイル (Test Files)
- テスト対象のファイル名 + `.spec` または `.test`
- 例:
  - `UserProfileCard.spec.ts`
  - `AuthenticationForm.test.ts`

### 3. 変数・関数命名 (Variable and Function Naming)

#### 変数命名 (Variable Naming)
- データ型や用途を反映
- プレフィックス/サフィックスで意味を明確化
- 例:
  - `isLoading`: ブール値
  - `userList`: 配列
  - `maxRetryCount`: 数値
  - `currentUserProfile`: オブジェクト

#### 関数・メソッド命名 (Function/Method Naming)
- 動詞 + 目的語の形式
- 明確な意図を示す
- 例:
  - `fetchUserData()`
  - `validateForm()`
  - `createNewUser()`
  - `updateUserProfile()`

#### イベントハンドラ (Event Handlers)
- `on`プレフィックス
- イベントの動作を示す
- 例:
  - `onSubmit`
  - `onCancel`
  - `onUserLogin`

### 4. 環境変数命名 (Environment Variable Naming)

#### Nuxt環境変数 (Nuxt Environment Variables)
- `NUXT_PUBLIC_`: クライアント側に公開可能な変数
- `NUXT_`: サーバーサイドのみの機密変数
- 大文字 + `SNAKE_CASE`
- 例:
  - `NUXT_PUBLIC_API_URL`
  - `NUXT_DATABASE_SECRET`

### 5. クラス・インターフェース命名 (Class and Interface Naming)

#### インターフェース (Interfaces)
- `I`プレフィックス（オプション）
- `PascalCase`
- 名詞または形容詞
- 例:
  - `IUser`
  - `UserProfile`
  - `Authenticatable`

#### 型エイリアス (Type Aliases)
- インターフェースと同様の規則
- 例:
  - `UserType`
  - `AuthenticationResponse`

### 6. CSS/Tailwind クラス命名 (CSS/Tailwind Class Naming)

#### カスタムクラス (Custom Classes)
- `kebab-case`
- 機能的な名前
- 例:
  - `user-card`
  - `login-form`
  - `primary-button`

### 7. API/エンドポイント命名 (API/Endpoint Naming)

#### RESTfulエンドポイント (RESTful Endpoints)
- 名詞（リソース）+ アクション
- 小文字 + ハイフン
- 例:
  - `/api/users`
  - `/api/products`
  - `/api/user-profile`

### 8. 命名の推奨プラクティス (Naming Best Practices)

- 一貫性を保つ
- 意味のある名前を選ぶ
- 自明でない略語は避ける
- コンテキストに応じた適切な命名
- 読みやすさと理解のしやすさを重視

### 9. 禁止される命名パターン (Forbidden Naming Patterns)

- 絵文字の使用
- 非英語の文字
- 意味のない省略形
- 予約語との衝突
- 特殊文字の使用

この命名規約は、コードの可読性、一貫性、保守性を向上させることを目的としています。プロジェクトの特性に応じて適宜調整してください。

## セキュリティ対策

### 1. 環境変数管理

- `.env` ファイルは絶対にGitHubにコミットしない
- `.gitignore` に `.env*` を必ず追加
- 環境変数は以下の種類に分類
  - `NUXT_PUBLIC_` プレフィックス: クライアント側に公開可能な変数
  - `NUXT_` プレフィックス: サーバーサイドのみで使用する機密変数

```typescript
// nuxt.config.ts
export default defineNuxtConfig({
  runtimeConfig: {
    // サーバーサイド専用の機密変数
    apiSecret: process.env.API_SECRET,
    
    // クライアント側に公開可能な変数
    public: {
      apiBase: process.env.NUXT_PUBLIC_API_BASE
    }
  }
})
```

### 2. 認証とセキュリティ

#### Supabase認証
- 常にサーバーサイドで認証トークンを検証
- クライアントサイドでは短命のセッショントークンを使用
- パスワードリセット、多要素認証を実装

```typescript
// server/middleware/auth.ts
export default defineEventHandler(async (event) => {
  const supabase = serverSupabaseClient(event)
  const session = await supabase.auth.getSession()
  
  if (!session) {
    throw createError({ 
      statusCode: 401, 
      message: '認証が必要です' 
    })
  }
})
```

#### パスワードポリシー
- 最小長さ: 12文字以上
- 複雑性要件:
  - 大文字
  - 小文字
  - 数字
  - 特殊文字
- パスワードハッシュは常にサーバーサイドで処理

### 3. 入力バリデーション

- サーバーサイドとクライアントサイドの両方でバリデーション
- zod または valibot を使用した型安全なバリデーション

```typescript
import { z } from 'zod'

const UserSchema = z.object({
  email: z.string().email('メールアドレスが無効です'),
  password: z.string()
    .min(12, 'パスワードは12文字以上必要です')
    .regex(/[A-Z]/, '大文字を含める必要があります')
    .regex(/[a-z]/, '小文字を含める必要があります')
    .regex(/[0-9]/, '数字を含める必要があります')
})
```

### 4. CORS設定

- 厳密なCORS設定
- 信頼できるオリジンのみを許可

```typescript
// nuxt.config.ts
export default defineNuxtConfig({
  nitro: {
    routeRules: {
      '/api/**': {
        cors: true,
        headers: {
          'Access-Control-Allow-Origin': 'https://trusted-domain.com',
          'Access-Control-Allow-Methods': 'GET,POST,PUT,DELETE,OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type, Authorization'
        }
      }
    }
  }
})
```

### 5. レートリミット

- APIエンドポイントにレートリミットを実装
- DoS攻撃から保護

```typescript
// server/api/限定エンドポイント.ts
import rateLimit from 'express-rate-limit'

export default defineEventHandler((event) => {
  const limiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15分
    max: 100 // IPあたり100リクエスト
  })
})
```

### 6. セキュリティヘッダー

```typescript
// nuxt.config.ts
export default defineNuxtConfig({
  nitro: {
    routeRules: {
      '/**': {
        headers: {
          'X-Frame-Options': 'DENY',
          'X-XSS-Protection': '1; mode=block',
          'X-Content-Type-Options': 'nosniff',
          'Referrer-Policy': 'strict-origin-when-cross-origin',
          'Content-Security-Policy': 
            "default-src 'self'; script-src 'self' 'unsafe-inline'"
        }
      }
    }
  }
})
```

### 7. ロギングとモニタリング

- 機密情報を含まないセキュアなロギング
- 異常検知とアラート設定

```typescript
// utils/logger.ts
export const secureLogger = {
  error(message: string, context?: Record<string, unknown>) {
    // 機密情報をマスク
    const sanitizedContext = maskSensitiveData(context)
    // ログ処理
  }
}
```

### 8. セキュリティスキャンと依存関係管理

- 定期的な脆弱性スキャン
- 依存関係の自動更新
- GitHub Dependabot の設定

```yaml
# .github/dependabot.yml
version: 2
updates:
  - package-ecosystem: "npm"
    directory: "/"
    schedule:
      interval: "weekly"
    open-pull-requests-limit: 10
    security-updates-limit: 5
```

### 9. データベースセキュリティ (Supabase)

- Row Level Security (RLS) の積極的な活用
- きめ細かな権限設定
- 最小権限の原則

```sql
-- SupabaseでのRow Level Security例
CREATE POLICY "Users can only see their own data" 
ON users FOR SELECT 
USING (auth.uid() = user_id);
```

### 10. クロスサイトスクリプティング（XSS）対策

#### 入力バリデーションと無害化
- すべてのユーザー入力を厳密にサニタイズ
- DOMPurifyライブラリを使用したHTML無害化

```typescript
import DOMPurify from 'dompurify'

// クライアントサイドでのサニタイズ
const sanitizedInput = DOMPurify.sanitize(userInput)

// サーバーサイドでのバリデーション
function sanitizeInput(input: string): string {
  return input
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;')
}
```

#### Content Security Policy (CSP)の強化
```typescript
// nuxt.config.ts
export default defineNuxtConfig({
  nitro: {
    routeRules: {
      '/**': {
        headers: {
          'Content-Security-Policy': [
            "default-src 'self'",
            "script-src 'self' 'nonce-random123' 'strict-dynamic'",
            "style-src 'self' 'nonce-random123'",
            "img-src 'self' data:",
            "connect-src 'self'",
            "font-src 'self'",
            "object-src 'none'",
            "base-uri 'self'"
          ].join('; ')
        }
      }
    }
  }
})
```

### 11. クロスサイトリクエストフォージェリ（CSRF）対策

#### トークンベースの保護
```typescript
// server/middleware/csrf.ts
import { generateToken, validateToken } from '~/utils/csrfProtection'

export default defineEventHandler(async (event) => {
  // POSTリクエスト時にCSRFトークンを検証
  if (event.method === 'POST') {
    const body = await readBody(event)
    const csrfToken = getHeader(event, 'x-csrf-token')
    
    if (!csrfToken || !validateToken(csrfToken)) {
      throw createError({
        statusCode: 403,
        message: '不正なリクエストです'
      })
    }
  }
})

// utils/csrfProtection.ts
export function generateToken(userId: string): string {
  const secret = useRuntimeConfig().csrfSecret
  return crypto
    .createHmac('sha256', secret)
    .update(userId)
    .digest('hex')
}

export function validateToken(token: string): boolean {
  // トークンの検証ロジック
  // 有効期限、ユーザー紐付けなどを確認
}
```

### 12. 追加のセキュリティ推奨事項

- 定期的なセキュリティ監査
- 侵入テストの実施
- セキュリティトレーニングの実施
- インシデント対応計画の策定

## コーディング規約

- ESLint/Prettier の標準的なルールに準拠
- Nuxt 3 のベストプラクティスに従う
- Composition API / `<script setup>` を優先
- サーバーサイドとクライアントサイドの明確な分離

## コンポーネント設計と実装の規約

### Nuxt 3 固有の規約追加

- `~/components/` に共通/汎用コンポーネント配置
- `~/pages/` にページコンポーネント配置
- `~/layouts/` にレイアウトコンポーネント配置
- サーバーコンポーネント (`*.server.vue`) の活用
- コンポーネントは型安全性を重視

### サーバーサイド API

- `~/server/api/` にAPIルートを配置
- トランスポート層のバリデーション
- エラーハンドリングの強化
- OpenAPI/Swagger仕様の自動生成

## テスト戦略

- Vitest によるユニットテスト
- Nuxt Test Utils によるコンポーネントテスト
- E2Eテストは Playwright を推奨
- 100%のカバレッジを目指す

## CI/CD パイプライン

1. GitHub Actions で自動テスト
2. Docker イメージのビルドと検証
3. デプロイメント自動化
4. セキュリティスキャン

### GitHub Actions 例

```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, development ]
  pull_request:
    branches: [ main, development ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
      - run: yarn install
      - run: yarn test
      - run: yarn lint

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker Image
        run: docker build -t myapp:${{ github.sha }} .
```

## 国際化 & アクセシビリティ

- `nuxt-i18n` による多言語対応
- WCAG 2.1 準拠
- aria 属性の積極的な活用
- パフォーマンスと accessibility スコアの向上

### インストール推奨パッケージ

```bash
# Vue/Nuxt エコシステム
yarn add -D @nuxt/devtools @nuxtjs/tailwindcss @pinia/nuxt nuxt-vue3-google-signin

# テスト関連
yarn add -D @nuxt/test-utils vitest @vitest/coverage-v8 playwright

# 国際化 & アクセシビリティ
yarn add -D nuxt-i18n @vueuse/nuxt @intlify/unplugin-vue-i18n
```

## その他のベストプラクティス

- コードスプリッティング
- 遅延ローディング
- プリフェッチ戦略
- Web Vitals の最適化
- セキュアなデフォルト設定

## 注意事項

1. 機密情報は `.env` で管理
2. `nuxt.config.ts` で環境変数の型安全性確保
3. サーバーサイドとクライアントサイドの環境変数を明確に区別

このガイドラインは、最新の Vue/Nuxt エコシステムとベストプラクティスを反映しています。プロジェクトの要件と状況に応じて柔軟に適用してください。
